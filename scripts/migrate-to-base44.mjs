import { promises as fs } from 'node:fs';
import path from 'node:path';

const rootDir = process.cwd();
const outputDir = path.join(rootDir, 'base44-workspace');
const pagesDir = path.join(rootDir, 'src', 'pages');
const componentsDir = path.join(rootDir, 'src', 'components');
const layoutFile = path.join(rootDir, 'src', 'Layout.jsx');
const globalsFile = path.join(rootDir, 'src', 'globals.css');
const supportingDirs = [
  'api',
  'assets',
  'config',
  'content',
  'entities',
  'hooks',
  'lib',
  'public',
  'styles',
  'supabase',
  'utils',
];

const exists = async (target) => {
  try {
    await fs.access(target);
    return true;
  } catch {
    return false;
  }
};

const listFiles = async (dir, extensions) => {
  if (!(await exists(dir))) {
    return [];
  }
  const entries = await fs.readdir(dir, { withFileTypes: true });
  const files = await Promise.all(
    entries.map(async (entry) => {
      const entryPath = path.join(dir, entry.name);
      if (entry.isDirectory()) {
        return listFiles(entryPath, extensions);
      }
      if (!extensions || extensions.some((ext) => entry.name.endsWith(ext))) {
        return [entryPath];
      }
      return [];
    })
  );
  return files.flat();
};

const toRelativePosix = (absolutePath, baseDir) =>
  path.relative(baseDir, absolutePath).split(path.sep).join('/');

const copyDirectory = async (source, destination) => {
  await fs.mkdir(destination, { recursive: true });
  await fs.cp(source, destination, { recursive: true });
};

const main = async () => {
  if (await exists(outputDir)) {
    await fs.rm(outputDir, { recursive: true, force: true });
  }

  await fs.mkdir(outputDir, { recursive: true });

  if (await exists(pagesDir)) {
    await copyDirectory(pagesDir, path.join(outputDir, '__pages__'));
  }

  if (await exists(componentsDir)) {
    await copyDirectory(componentsDir, path.join(outputDir, '__components__'));
  }

  await Promise.all(
    supportingDirs.map(async (dir) => {
      const sourceDir = path.join(rootDir, 'src', dir);
      if (await exists(sourceDir)) {
        await copyDirectory(sourceDir, path.join(outputDir, dir));
      }
    })
  );

  if (await exists(layoutFile)) {
    await fs.copyFile(layoutFile, path.join(outputDir, 'Layout.jsx'));
  }

  if (await exists(globalsFile)) {
    await fs.copyFile(globalsFile, path.join(outputDir, 'globals.css'));
  }

  const pageFiles = await listFiles(pagesDir, ['.jsx', '.js']);
  const componentFiles = await listFiles(componentsDir, ['.jsx', '.js']);

  const appConfig = {
    generatedAt: new Date().toISOString(),
    pages: pageFiles.map((file) => toRelativePosix(file, pagesDir)),
    components: componentFiles.map((file) => toRelativePosix(file, componentsDir)),
    supportingDirs,
    layout: (await exists(layoutFile)) ? 'Layout.jsx' : null,
    globals: (await exists(globalsFile)) ? 'globals.css' : null,
  };

  const configContents = `// Auto-generated by scripts/migrate-to-base44.mjs\n` +
    `export const appConfig = ${JSON.stringify(appConfig, null, 2)};\n`;

  await fs.writeFile(path.join(outputDir, '__app.config.js__'), configContents, 'utf8');

  console.log(`Base44 workspace generated at: ${outputDir}`);
};

main().catch((error) => {
  console.error('Failed to generate Base44 workspace:', error);
  process.exitCode = 1;
});
